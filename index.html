<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNO Live â€“ by Mr.K</title>
  <style>
    :root {
      --bg:#0f1220; --card-bg:#171a2b; --text:#e8ecff; --muted:#9aa3c7; --accent:#7aa2ff;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text);
      background-color: #333;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .wrap { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
    .header {
      display:flex; flex-direction: column; align-items:center; justify-content:center; gap: 0;
      background: rgba(0, 0, 0, 0.35); backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,0.1); padding: 12px 14px;
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25); margin-bottom: 16px; cursor: pointer;
      position: relative;
    }
    .header .banner-img {
        width: 100%;
        max-width: 600px;
        height: 160px;
        object-fit: cover; /* ÙŠÙ‚Øµ Ø§Ù„Ø²Ø§ÙŠØ¯ ÙˆÙŠØ®Ù„ÙŠ Ø§Ù„Ø´ÙƒÙ„ Ù…Ø¶Ø¨ÙˆØ· */
        border-radius: 16px; /* ÙŠØ®Ù„ÙŠ Ø§Ù„Ø­ÙˆØ§Ù Ù†Ø§Ø¹Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
    }
    .title {
        position: absolute;
        top: 18px;
        right: 18px;
        font-weight: 800; letter-spacing:.5px; font-size: 16px;
        display:flex; align-items:center; gap:8px;
        background: rgba(0,0,0,0.4);
        padding: 4px 8px;
        border-radius: 8px;
    }
    .title .badge { font-size: 11px; color: var(--text); background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 999px; }
    .grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .card {
      /* ØªÙ… Ø­Ø°Ù Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø«Ø§Ø¨Øª Ù…Ù† Ù‡Ù†Ø§ Ù„ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª */
      border-radius:16px; padding:16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      position: relative; user-select: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .card-body {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 12px;
    }
    .score-area {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .score-card {
        background-color: rgba(0,0,0,0.2);
        border-radius: 8px;
        padding: 12px 8px;
        font-size: 36px;
        font-weight: 900;
        text-align: center;
        width: 60px;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .arrow-group { display: flex; flex-direction: column; gap: 6px; }
    .arrow {
        width: 40px; height: 40px;
        display:grid; place-items:center;
        border-radius:8px; background:rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.15);
        user-select:none; cursor: pointer; font-size: 20px;
    }
    .arrow:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
    .center-col { text-align: center; }
    .emoji { font-size: 52px; line-height: 1; cursor: pointer; }
    .name {
        margin-top:8px;
        font-weight:bold;
        font-size:18px;
        direction: ltr;
        text-align: center;
        unicode-bidi: plaintext;
    }
    .badges { display:flex; justify-content:space-between; gap:8px; margin-top:12px; font-size:22px; min-height: 26px; padding: 0 10px; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(5px); display:none; align-items:center; justify-content:center; z-index:40; }
    .modal{ width:min(92vw,560px); background:#151935; border:1px solid #2a3257; border-radius:18px; padding:18px; }
    .modal h3{ margin:0 0 16px; text-align: center; }
    .input, input[type=text]{ width:100%; background:#0f142e; color:var(--text); border:1px solid #28325b; border-radius:12px; padding:10px 12px; outline:none; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .room-info { text-align: center; margin-bottom: 16px; background: #0f142e; padding: 10px; border-radius: 10px; border: 1px dashed #2a3257; }
    .room-info span { font-weight: bold; font-size: 18px; color: var(--accent); }
    hr { border-color: #2a32573d; margin: 16px 0; }
    .btn {
        border-radius: 999px;
        font-weight: bold;
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: transform 0.2s ease;
        cursor: pointer;
        padding: 10px 14px;
    }
    .btn:hover { transform: translateY(-2px); }
    .add-player-fab {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background-color: #6c5ce7; color: white;
        padding: 12px 24px; font-size: 18px;
        display: flex; align-items: center; justify-content: center;
        gap: 8px; z-index: 30;
        border-radius: 999px; font-weight: bold; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
    }
    .add-player-fab:hover { transform: translateX(-50%) translateY(-2px); }
    .corner-btn {
        position: fixed;
        bottom: 20px;
        background: #e74c3c;
        color: white;
        padding: 10px 20px;
        border-radius: 999px;
        z-index: 30;
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        display: grid;
        place-items: center;
        transition: transform 0.2s ease;
    }
    .corner-btn:hover { transform: translateY(-2px); }
    #devInfoBtn { left: 20px; }
    #refreshBtn { right: 20px; background: #3498db; }
    .info-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .info-item a { color: var(--text); text-decoration: none; }
    .info-item a:hover { color: var(--accent); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header" id="roomBanner">
      <img id="bannerImage" src="./banner.jpg" alt="UNO Live Banner" class="banner-img">
      <div class="title">
        <span>ğŸ®</span>
        <span class="badge" id="roomStatus"></span>
      </div>
    </div>
    <div class="grid" id="players"></div>
  </div>

  <button class="add-player-fab" id="addPlayerFab"><span>+</span> Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
  <button class="corner-btn" id="devInfoBtn">MR.K</button>
  <button class="corner-btn" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>

  <!-- Modals -->
  <div class="modal-backdrop" id="roomModal"><div class="modal"><div id="roomManagementView"><h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±ÙØ©</h3><div class="room-info" id="roomInfoBlock">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="modalRoomId"></span></div><div class="row2" style="margin-bottom: 10px;"><button class="btn" id="openLog">ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button><button class="btn" id="copyLinkBtn">ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</button></div><hr><div class="row2"><button class="btn" id="doCreate">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button><button class="btn" id="showJoinView">ğŸšª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø£Ø®Ø±Ù‰</button></div></div><div id="joinView" style="display: none;"><h3>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</h3><div style="display:flex; gap:6px; align-items:center;"><input type="text" id="joinId" class="input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©" /><button class="btn" id="doJoin">Ø¯Ø®ÙˆÙ„</button></div><button class="btn" id="backToManagement" style="margin-top: 10px; background: #2a3257;">Ø±Ø¬ÙˆØ¹</button></div><hr><div style="display:flex; justify-content:flex-end;"><button class="btn" id="closeRoomModal">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>
  <div class="modal-backdrop" id="logModal"><div class="modal"><h3>Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒØ¤ÙˆØ³</th><th>Ø§Ù„Ù…ÙŠØ¯Ø§Ù„ÙŠØ§Øª</th></tr></thead><tbody id="logTbody"></tbody></table><div style="margin-top:10px; display:flex; justify-content:flex-end;"><button class="btn" id="closeLog">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>
  <div class="modal-backdrop" id="deleteModal"><div class="modal"><h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3><p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ</p><div class="row2"><button class="btn" id="deletePlayerBtn">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯</button><button class="btn" id="deleteAllBtn" style="background-color:#ff4d4f; border-color:#ff4d4f;">ğŸ’¥ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button></div><hr><div style="display:flex; justify-content:flex-end;"><button class="btn" id="closeDeleteModal">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
  <div class="modal-backdrop" id="devInfoModal"><div class="modal"><h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ±</h3><div class="info-item"><span>ğŸ§‘â€ğŸ’»</span> <b>Mr.K</b></div><div class="info-item"><span>ğŸ“</span> <a href="tel:+96899678553">99678553</a><a href="https://wa.me/96899678553" target="_blank" style="font-size: 24px; margin-right: auto;">ğŸ’¬</a></div><div class="info-item"><span>âœ‰ï¸</span> <a href="mailto:scoon80@gmail.com">scoon80@gmail.com</a></div><hr><p style="text-align:center;">Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ÙƒÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p><div style="display:flex; justify-content:flex-end;"><button class="btn" id="closeDevInfoModal">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, child, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    function setRandomBackground() {
      const imageCount = 8;
      const randomIndex = Math.floor(Math.random() * imageCount) + 1;
      const imageUrl = `./background${randomIndex}.jpg`;
      document.body.style.backgroundImage = `url('${imageUrl}')`;
    }

    function setRandomBanner() {
      const bannerCount = 4; // Ø¹Ø¯Ø¯ ØµÙˆØ± Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
      const randomIndex = Math.floor(Math.random() * bannerCount);
      let bannerUrl;
      
      if (randomIndex === 0) {
        bannerUrl = './banner.jpg'; // Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
      } else {
        bannerUrl = `./banner${randomIndex}.jpg`; // Ø§Ù„Ø¨Ù†Ø±Ø§Øª Ø§Ù„Ù…Ø±Ù‚Ù…Ø©
      }
      
      document.getElementById('bannerImage').src = bannerUrl;
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ù„ÙˆÙ† hex Ø¥Ù„Ù‰ rgba
    function hexToRgba(hex, alpha = 1) {
        const [r, g, b] = hex.match(/\w\w/g).map(x => parseInt(x, 16));
        return `rgba(${r},${g},${b},${alpha})`;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBGuiMxffwcm_P8zY-I6hMUG1hUY1akpFA",
      authDomain: "uno-game-live.firebaseapp.com",
      databaseURL: "https://uno-game-live-default-rtdb.firebaseio.com",
      projectId: "uno-game-live",
      storageBucket: "uno-game-live.appspot.com",
      messagingSenderId: "973862287578",
      appId: "1:973862287578:web:0bac6d3788c78666e48de3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const qs = new URLSearchParams(location.search);
    let roomId = qs.get("room") || localStorage.getItem("uno-room-id") || "";
    let adminToken = qs.get("admin") || JSON.parse(localStorage.getItem("uno-admin-tokens") || '{}')[roomId];
    let isAdmin = false;

    const playersEl = document.getElementById("players");
    const roomStatus = document.getElementById("roomStatus");
    const modalRoomId = document.getElementById("modalRoomId");
    let currentTargetPlayerId = null;
    
   let lastCups = {};
    
    const medalSound = new Audio('./medal.mp3'); 
    medalSound.preload = "auto";

    const cupSound = new Audio('./cup.mp3'); 
    cupSound.preload = "auto";

    medalSound.volume = 0.5;
    cupSound.volume = 0.6;

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØª Ø¹Ø´Ø§Ù† ÙŠØ´ØªØºÙ„ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¯ÙˆÙ† Ø­Ø¸Ø±
   document.body.addEventListener("click", () => {
   medalSound.play().catch(()=>{});
   cupSound.play().catch(()=>{});
   }, { once: true });



    const ALL_EMOJIS = ['ğŸ¤ ','ğŸ˜','ğŸ¥·','ğŸ¤¡','ğŸ¦¸','ğŸ¦¹','ğŸ‘½','ğŸ¤–','ğŸ‘‘','ğŸ¦','ğŸ¯','ğŸº','ğŸ²','ğŸ¦Š','ğŸ¸','ğŸµ','ğŸ¦‰','ğŸ¨','ğŸ‘¨â€ğŸš€','ğŸ‘©â€ğŸš€','ğŸ‘¨â€ğŸ¨','ğŸ‘©â€ğŸ¨','ğŸ‘¨â€ğŸ’»','ğŸ‘©â€ğŸ’»','ğŸ‘¨â€ğŸ”¬','ğŸ‘©â€ğŸ”¬'];
    const CARD_COLORS = ["#8e44ad", "#e67e22", "#c0392b", "#2980b9", "#27ae60", "#f39c12", "#16a085"];

    const makeId = () => Math.random().toString(36).slice(2, 8);
    const todayTag = () => new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short'}).replace(/ /g,'').toUpperCase();

    function getMedals(score) {
        const gold = Math.floor((score || 0) / 5);
        const silver = (score || 0) % 5;
        return "ğŸ¥‡".repeat(gold) + "ğŸ¥ˆ".repeat(silver);
    }

    function playerCard(p, index){
      // ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ÙˆÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ rgba Ù…Ø¹ Ø´ÙØ§ÙÙŠØ© 80%
      const cardColor = p.color || CARD_COLORS[index % CARD_COLORS.length];
      const transparentColor = hexToRgba(cardColor, 0.8);

      return `
        <div class="card" data-player-id="${p.id}" style="background-color: ${cardColor};">
          <div class="card-body">
            <div class="score-area">
              <div class="arrow-group">
                <div class="arrow" data-act="left:+1">â–²</div>
                <div class="arrow" data-act="left:-1">â–¼</div>
              </div>
              <div class="score-card">${p.left||0}</div>
            </div>
            <div class="center-col">
              <div class="emoji">${p.character||'ğŸ®'}</div>
              <div class="name">${p.name||'Ù„Ø§Ø¹Ø¨'}</div>
            </div>
            <div class="score-area">
              <div class="score-card">${p.right||0}</div>
              <div class="arrow-group">
                <div class="arrow" data-act="right:+1">â–²</div>
                <div class="arrow" data-act="right:-1">â–¼</div>
              </div>
            </div>
          </div>
          <div class="badges"><span>${getMedals(p.left)}</span><span>${"ğŸ†".repeat(p.right||0)}</span></div>
        </div>
      `;
    }

    function renderPlayers(list){
      playersEl.innerHTML = list.map((p, i) => playerCard(p, i)).join("");
    }

function listenRoom(){
  if(!roomId) return;
  roomStatus.textContent = isAdmin ? 'Ù…Ø´Ø±Ù' : 'Ù…Ø´Ø§Ù‡Ø¯';
  modalRoomId.textContent = roomId;
  localStorage.setItem("uno-room-id", roomId);

  onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
    const playersData = snap.exists() ? snap.val() : {};
    const players = Object.entries(playersData).map(([id,v])=>({id, ...v}));
    players.sort((a,b)=> (b.right||0)-(a.right||0) || (b.left||0)-(a.left||0));
    renderPlayers(players);

    // ğŸ”¥ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙƒØ¤ÙˆØ³ ÙˆØ¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø§Ø±ÙŠØ©
    players.forEach(p => {
      const prev = lastCups[p.id] || 0;
      if ((p.right || 0) > prev) {
        triggerFireworks(); // ğŸ† ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹
      }
      lastCups[p.id] = p.right || 0;
    });
  });
}


    async function ensureAdminStatus(){
      if(!roomId || !adminToken) {
        isAdmin = false;
        return false;
      }
      const snap = await get(child(ref(db, `rooms/${roomId}`), 'adminKey'));
      isAdmin = !!(snap.exists() && adminToken === snap.val());
      document.getElementById('addPlayerFab').style.display = isAdmin ? 'flex' : 'none';
      return isAdmin;
    }

    function handleScoreUpdate(id, side, delta) {
        if (!isAdmin) return;
        const playerRef = ref(db, `rooms/${roomId}/players/${id}`);
        get(playerRef).then(pSnap => {
            if(!pSnap.exists()) return;
            const p = pSnap.val();
            const newValue = Math.max(0, (p[side] || 0) + delta);

            update(playerRef, { [side]: newValue });

            const date = todayTag();
            const updatedLog = {
                date: date,
                name: p.name,
                wins: side === 'right' ? newValue : p.right || 0,
                medals: side === 'left' ? newValue : p.left || 0
            };
            update(ref(db, `rooms/${roomId}/scoreLog/${date}_${p.name}`), updatedLog);

            if (delta > 0) { 
  (side === 'left' ? medalSound : cupSound).play().catch(err=>console.log(err)); 
  if (side === 'right') triggerFireworks(); // Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø§Ø±ÙŠØ© ÙÙ‚Ø· Ù„Ù„ÙƒØ¤ÙˆØ³
}
        });
    }

    const addPlayers = async () => {
      if(!roomId || !isAdmin) {
        alert("ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø´Ø±ÙØ§Ù‹ ÙÙŠ ØºØ±ÙØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨.");
        return;
      }
      const namesInput = prompt("Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ù…ÙØµÙˆÙ„Ø© Ø¨Ù…Ø³Ø§ÙØ©):");
      if(!namesInput) return;
      const names = namesInput.trim().split(/\s+/).filter(name => name.length > 0);
      if(names.length === 0) return;
      const playersSnap = await get(ref(db, `rooms/${roomId}/players`));
      const players = playersSnap.exists() ? playersSnap.val() : {};
      let usedEmojis = Object.values(players).map(p => p.character);
      let usedColors = Object.values(players).map(p => p.color);
      for (const name of names) {
        let availableEmojis = ALL_EMOJIS.filter(e => !usedEmojis.includes(e));
        if (availableEmojis.length === 0) availableEmojis = ALL_EMOJIS;
        const char = availableEmojis[Math.floor(Math.random() * availableEmojis.length)];
        usedEmojis.push(char);
        let availableColors = CARD_COLORS.filter(c => !usedColors.includes(c));
        if (availableColors.length === 0) availableColors = CARD_COLORS;
        const color = availableColors[0];
        usedColors.push(color);
        await set(child(ref(db, `rooms/${roomId}/players`), makeId()), { name, left:0, right:0, character:char, color });
      }
    };
    document.getElementById('addPlayerFab').onclick = addPlayers;

    const roomModal = document.getElementById("roomModal");
    const logModal = document.getElementById("logModal");
    const deleteModal = document.getElementById("deleteModal");
    const devInfoModal = document.getElementById("devInfoModal");
    const roomManagementView = document.getElementById('roomManagementView');
    const joinView = document.getElementById('joinView');
    const roomInfoBlock = document.getElementById('roomInfoBlock');

    const openModal = (m)=> m.style.display = "flex";
    const closeModal = (m)=> m.style.display = "none";

    document.getElementById("roomBanner").onclick = () => {
        roomManagementView.style.display = 'block';
        joinView.style.display = 'none';

        const hasRoom = !!roomId;
        roomInfoBlock.style.display = hasRoom ? 'block' : 'none';
        document.getElementById('openLog').style.display = hasRoom ? 'block' : 'none';
        document.getElementById('copyLinkBtn').style.display = hasRoom ? 'block' : 'none';

        openModal(roomModal);
    };
    document.getElementById("closeRoomModal").onclick = () => closeModal(roomModal);
    document.getElementById("openLog").onclick = () => {
        closeModal(roomModal);
        const tbody = document.getElementById("logTbody");
        onValue(ref(db, `rooms/${roomId}/scoreLog`), (snap) => {
            if(!snap.exists()){ tbody.innerHTML = `<tr><td colspan="4" class="subtle">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</td></tr>`; return; }
            const list = Object.values(snap.val());
            list.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
            tbody.innerHTML = list.map(e=>`<tr><td>${e.date}</td><td>${e.name}</td><td>${e.wins||0}</td><td>${e.medals||0}</td></tr>`).join("");
        }, { onlyOnce: true });
        openModal(logModal);
    };
    document.getElementById("closeLog").onclick = () => closeModal(logModal);
    document.getElementById("closeDeleteModal").onclick = () => closeModal(deleteModal);
    document.getElementById("devInfoBtn").onclick = () => openModal(devInfoModal);
    document.getElementById("closeDevInfoModal").onclick = () => closeModal(devInfoModal);
    document.getElementById("refreshBtn").onclick = () => location.reload();

    document.getElementById('showJoinView').onclick = () => { roomManagementView.style.display = 'none'; joinView.style.display = 'block'; };
    document.getElementById('backToManagement').onclick = () => { joinView.style.display = 'none'; roomManagementView.style.display = 'block'; };

    document.getElementById("doCreate").onclick = async () => {
      const newRoomId = makeId();
      const newAdminKey = makeId();
      await set(ref(db, `rooms/${newRoomId}`), { createdAt: Date.now(), adminKey: newAdminKey });

      const adminTokens = JSON.parse(localStorage.getItem("uno-admin-tokens") || '{}');
      adminTokens[newRoomId] = newAdminKey;
      localStorage.setItem("uno-admin-tokens", JSON.stringify(adminTokens));

      history.replaceState({}, "", `${location.origin}${location.pathname}?room=${newRoomId}&admin=${newAdminKey}`);
      location.reload();
    };
    document.getElementById("doJoin").onclick = async () => {
      const joinRoomId = document.getElementById("joinId").value.trim();
      if(!joinRoomId){ alert("Ø§ÙƒØªØ¨ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©"); return; }
      const exists = (await get(child(ref(db, 'rooms'), joinRoomId))).exists();
      if(!exists){ alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"); return; }

      const adminTokens = JSON.parse(localStorage.getItem("uno-admin-tokens") || '{}');
      const newAdminToken = adminTokens[joinRoomId] || '';

      const url = new URL(location.href);
      url.searchParams.set('room', joinRoomId);
      if (newAdminToken) {
        url.searchParams.set('admin', newAdminToken);
      } else {
        url.searchParams.delete('admin');
      }
      history.replaceState({}, "", url.toString());
      location.reload();
    };
    document.getElementById('copyLinkBtn').onclick = () => {
        const viewUrl = new URL(location.href);
        viewUrl.searchParams.delete('admin');
        navigator.clipboard.writeText(viewUrl.toString()).then(() => alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©!'), () => alert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·.'));
    };
    document.getElementById('deletePlayerBtn').onclick = () => {
        if (currentTargetPlayerId) { remove(ref(db, `rooms/${roomId}/players/${currentTargetPlayerId}`)); }
        closeModal(deleteModal);
    };
    document.getElementById('deleteAllBtn').onclick = () => {
        if (confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
            remove(ref(db, `rooms/${roomId}/players`));
        }
        closeModal(deleteModal);
    };

    function initializeEventListeners() {
        let longPressTimer;
        let isLongPress = false;
        let touchEventDetected = false;

        const handlePress = (target) => {
            if (!isAdmin) return;
            const emojiEl = target.closest('.emoji');
            if (emojiEl) {
                isLongPress = false;
                const card = emojiEl.closest('.card');
                currentTargetPlayerId = card.dataset.playerId;
                longPressTimer = setTimeout(() => {
                    isLongPress = true;
                    openModal(document.getElementById('deleteModal'));
                }, 800);
            }
        };

        const handleRelease = (target) => {
            clearTimeout(longPressTimer);
            const arrow = target.closest('.arrow');
            if (arrow && !isLongPress) {
                const card = arrow.closest('.card');
                const playerId = card.dataset.playerId;
                const { act } = arrow.dataset;
                const [side, deltaStr] = act.split(":");
                handleScoreUpdate(playerId, side, parseInt(deltaStr, 10));
            }
        };

        playersEl.addEventListener('touchstart', (e) => {
            touchEventDetected = true;
            handlePress(e.target);
        }, { passive: true });

        playersEl.addEventListener('touchend', (e) => {
            if (!touchEventDetected) return;
            handleRelease(e.target);
        });

        playersEl.addEventListener('mousedown', (e) => {
            if (touchEventDetected || e.button !== 0) return;
            handlePress(e.target);
        });

        playersEl.addEventListener('mouseup', (e) => {
            if (touchEventDetected || e.button !== 0) return;
            handleRelease(e.target);
        });

        const cancelPress = () => clearTimeout(longPressTimer);
        playersEl.addEventListener('touchcancel', cancelPress);
        playersEl.addEventListener('mouseleave', cancelPress);
    }

function triggerFireworks() {
  const duration = 5000; // 5 Ø«ÙˆØ§Ù†ÙŠ
  const animationEnd = Date.now() + duration;
  const colors = ['#ff0', '#ff6600', '#00ffcc', '#ff0066', '#00ff00', '#3399ff'];

  (function frame() {
    // Ù„Ùˆ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª ÙˆÙ‚Ù
    if (Date.now() > animationEnd) return;

    // ØªÙˆÙ„ÙŠØ¯ Ø¯ÙØ¹Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ø´Ø±Ø§Ø±Ø§Øª
    confetti({
      particleCount: 5 + Math.random() * 10,
      startVelocity: 20 + Math.random() * 15,
      spread: 360,
      origin: {
        x: Math.random(),
        y: Math.random() - 0.2
      },
      colors: [colors[Math.floor(Math.random() * colors.length)]],
    });

    // ÙƒØ±Ø± Ø¨Ø³Ø±Ø¹Ø© (ÙƒÙ„ 200ms)
    requestAnimationFrame(frame);
  }());
}


  let frame = 0;
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      p.x += Math.cos(p.angle) * p.speed;
      p.y += Math.sin(p.angle) * p.speed;
      p.alpha -= p.decay;
      ctx.fillStyle = p.color;
      ctx.globalAlpha = Math.max(p.alpha, 0);
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
      ctx.fill();
    });
    frame++;
    if (frame < 180) { // Ø­ÙˆØ§Ù„ÙŠ 3 Ø«ÙˆØ§Ù†ÙŠ (60fps Ã— 3)
      requestAnimationFrame(animate);
    } else {
      document.body.removeChild(canvas);
    }
  }
  animate();
}



    (async function boot(){
      setRandomBackground();
      setRandomBanner();
      if(!roomId){
        roomStatus.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
        document.getElementById('addPlayerFab').style.display = 'none';
        openModal(document.getElementById('roomModal'));
      } else {
        await ensureAdminStatus();
        listenRoom();
      }
      initializeEventListeners();
    })();
  </script>
</body>
</html>
