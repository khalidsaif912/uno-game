<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNO Live â€“ by Mr.K</title>
  <style>
    :root {
      --bg:#0f1220; --card-bg:#171a2b; --text:#e8ecff; --muted:#9aa3c7; --accent:#7aa2ff;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text); 
      background: linear-gradient(135deg, #0f1220, #1a1f35, #252b45) !important;
      background-attachment: fixed;
    }
    .wrap { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
    .header {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 0; background: rgba(0, 0, 0, 0.35); backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1); padding: 12px 14px;
      border-radius: 14px; box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
      cursor: pointer; position: relative; width: 100%; margin-bottom: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .header:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, .35);
    }
    .header .banner-img { width: 100%; height: 120px; object-fit: cover; object-position: center; border-radius: 8px; }
    .title {
      position: absolute; top: 18px; right: 18px; font-weight: 800; letter-spacing:.5px;
      font-size: 16px; display:flex; align-items:center; gap:8px;
      background: rgba(0,0,0,0.4); padding: 4px 8px; border-radius: 8px;
    }
    .title .badge { font-size: 11px; color: var(--text); background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 999px; }
    .grid { display: flex; flex-direction: column; gap: 12px; }
    .card {
      border-radius:16px; padding: 6px 16px 2px 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      position: relative; user-select: none; border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.4);
    }
    .card-body { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; }
    .score-area { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .score-card {
      background-color: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px 8px;
      font-size: 36px; font-weight: 900; text-align: center; width: 60px;
      border: 1px solid rgba(255,255,255,0.1); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .arrow-group { display: flex; flex-direction: column; gap: 6px; }
    .arrow {
      width: 40px; height: 40px; display:grid; place-items:center; border-radius:8px;
      background:rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
      user-select:none; cursor: pointer; font-size: 20px;
      transition: all 0.2s ease;
    }
    .arrow:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.05);
    }
    .arrow:active { 
      transform: scale(0.95); 
      background: rgba(255,255,255,0.3); 
    }
    .center-col { text-align: center; }
    .emoji { 
      font-size: 52px; line-height: 1; cursor: pointer; 
      transition: transform 0.2s ease;
    }
    .emoji:hover {
      transform: scale(1.1);
    }
    .name { margin-top:8px; font-weight:bold; font-size:18px; direction: ltr; text-align: center; unicode-bidi: plaintext; }
    .badges { display: flex; justify-content: space-between; gap: 8px; margin-top: 4px; font-size: 20px; min-height: 22px; padding: 0 10px; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(5px); display:none; align-items:center; justify-content:center; z-index:110; }
    .modal{ width:min(92vw,560px); background:#151935; border:1px solid #2a3257; border-radius:18px; padding:18px; }
    .modal h3{ margin:0 0 16px; text-align: center; }
    .input, input[type=text]{ width:100%; background:#0f142e; color:var(--text); border:1px solid #28325b; border-radius:12px; padding:10px 12px; outline:none; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .room-info { text-align: center; margin-bottom: 16px; background: #0f142e; padding: 10px; border-radius: 10px; border: 1px dashed #2a3257; }
    .room-info span { font-weight: bold; font-size: 18px; color: var(--accent); }
    hr { border-color: #2a32573d; margin: 16px 0; }
    .btn { border-radius: 999px; font-weight: bold; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s ease; cursor: pointer; padding: 10px 14px; }
    .btn:hover { transform: translateY(-2px); }
    .add-player-fab, .corner-btn { 
      position: fixed; bottom: 20px; border-radius: 999px; border: none; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-weight: bold; 
      z-index: 30; 
    }
    .add-player-fab { left: 50%; transform: translateX(-50%); background-color: #6c5ce7; color: white; padding: 12px 24px; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .corner-btn { color: white; padding: 10px 20px; font-size: 14px; display: grid; place-items: center; }
    #devInfoBtn { left: 20px; background: #e74c3c; }
    #refreshBtn { right: 20px; background: #3498db; }
    .info-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .info-item a { color: var(--text); text-decoration: none; }
    .info-item a:hover { color: var(--accent); }
    #confetti-canvas, #screen-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; visibility: hidden; opacity: 0; }
    #confetti-canvas { z-index: 120; transition: opacity 0.3s; }
    #screen-flash { z-index: 121; background-color: white; transition: opacity 0.5s ease-out; }
    #confetti-canvas.active, #screen-flash.active { visibility: visible; opacity: 1; }
    #screen-flash.active { opacity: 0.7; }
 
 
 
 
    
  /* --- Ù„Ù…Ø³Ø© Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† --- */
#playerNamesInput {
    resize: vertical; /* ØªØ³Ù…Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø­Ù‚Ù„ Ø¹Ù…ÙˆØ¯ÙŠÙ‹Ø§ ÙÙ‚Ø· */
    font-size: 16px;
    text-align: center;
}
  
    
    
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>
  <div id="screen-flash"></div>
  <div class="wrap">
    <div id="header-container"></div>
    <div class="grid" id="players"></div>
  </div>

  <button class="add-player-fab btn" id="addPlayerFab"><span>+</span> Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
  <button class="corner-btn btn" id="devInfoBtn">MR.K</button>
  <button class="corner-btn btn" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>

  <!-- Modals -->
  <div class="modal-backdrop" id="roomModal"><div class="modal"><div id="roomManagementView"><h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±ÙØ©</h3><div class="room-info" id="roomInfoBlock">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="modalRoomId"></span></div><div class="row2" style="margin-bottom: 10px;"><button class="btn" id="openLog">ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button><button class="btn" id="copyLinkBtn">ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</button></div><hr><div class="row2"><button class="btn" id="doCreate">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button><button class="btn" id="showJoinView">ğŸšª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø£Ø®Ø±Ù‰</button></div></div><div id="joinView" style="display: none;"><h3>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</h3><div style="display:flex; gap:6px; align-items:center;"><input type="text" id="joinId" class="input" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©" /><button class="btn" id="doJoin">Ø¯Ø®ÙˆÙ„</button></div><button class="btn" id="backToManagement" style="margin-top: 10px; background: #2a3257;">Ø±Ø¬ÙˆØ¹</button></div><hr><div style="display:flex; justify-content:flex-end;"><button class="btn" id="closeRoomModal">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>
  <div class="modal-backdrop" id="logModal"><div class="modal"><h3>Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒØ¤ÙˆØ³</th><th>Ø§Ù„Ù…ÙŠØ¯Ø§Ù„ÙŠØ§Øª</th></tr></thead><tbody id="logTbody"></tbody></table><div style="margin-top:10px; display:flex; justify-content:flex-end;"><button class="btn" id="closeLog">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>
  <div class="modal-backdrop" id="deleteModal"><div class="modal"><h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3><p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ</p><div class="row2"><button class="btn" id="deletePlayerBtn">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯</button><button class="btn" id="deleteAllBtn" style="background-color:#ff4d4f; border-color:#ff4d4f;">ğŸ’¥ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button></div><hr><div style="display:flex; justify-content:flex-end;"><button class="btn" id="closeDeleteModal">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
  <div class="modal-backdrop" id="devInfoModal"><div class="modal"><h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ±</h3><div class="info-item"><span>ğŸ§‘â€ğŸ’»</span> <b>Mr.K</b></div><div class="info-item"><span>ğŸ“</span> <a href="tel:+96899678553">99678553</a><a href="https://wa.me/96899678553" target="_blank" style="font-size: 24px; margin-right: auto;">ğŸ’¬</a></div><div class="info-item"><span>âœ‰ï¸</span> <a href="mailto:scoon80@gmail.com">scoon80@gmail.com</a></div><hr><p style="text-align:center;">Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ÙƒÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p><div style="display:flex; justify-content:flex-end;"><button class="btn" id="closeDevInfoModal">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>

<!-- â–¼â–¼â–¼ Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© â–¼â–¼â–¼ -->
<div class="modal-backdrop" id="addPlayerModal">
  <div class="modal">
    <h3>âœ¨ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¬Ø¯Ø¯</h3>
    <p class="subtle" style="text-align: center; margin-top: -10px; margin-bottom: 16px;">
      Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…ÙØµÙˆÙ„Ø© Ø¨Ù…Ø³Ø§ÙØ© Ø£Ùˆ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯.
    </p>
    
    <!-- (1) Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ textarea Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† input Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø£Ø³Ø·Ø± Ù…ØªØ¹Ø¯Ø¯Ø© -->
    <textarea id="playerNamesInput" class="input" rows="5" placeholder="Ø¹Ù„ÙŠ Ù…Ø§Ù‡Ø± Ù…Ø¹Ø§Ø°..."></textarea>
    
    <hr>
    
    <div class="row2">
      <!-- (2) Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
      <button class="btn" id="doAddPlayers" style="background-color: #27ae60;">âœ”ï¸ Ø¥Ø¶Ø§ÙØ©</button>
      <!-- (3) Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ -->
      <button class="btn" id="closeAddPlayerModal" style="background-color: #c0392b;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>
<!-- â–²â–²â–² Ø§Ù†ØªÙ‡Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© â–²â–²â–² -->




  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, child, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGuiMxffwcm_P8zY-I6hMUG1hUY1akpFA",
      authDomain: "uno-game-live.firebaseapp.com",
      databaseURL: "https://uno-game-live-default-rtdb.firebaseio.com",
      projectId: "uno-game-live",
      storageBucket: "uno-game-live.appspot.com",
      messagingSenderId: "973862287578",
      appId: "1:973862287578:web:0bac6d3788c78666e48de3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const qs = new URLSearchParams(location.search);
    let roomId = qs.get("room") || localStorage.getItem("uno-room-id") || "";
    let adminToken = qs.get("admin") || JSON.parse(localStorage.getItem("uno-admin-tokens") || '{}')[roomId];
    let isAdmin = false;

    const headerContainer = document.getElementById("header-container");
    const playersEl = document.getElementById("players");
    const modalRoomId = document.getElementById("modalRoomId");
    let currentTargetPlayerId = null;

// --- Ø§Ù„Ø£ØµÙˆØ§Øª ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ---

// ØµÙˆØª Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¹Ø§Ù…
const clickSound = new Audio('./click.mp3');
clickSound.volume = 0.8;

// ØµÙˆØª Ø§Ù„ÙÙˆØ² Ø¨Ø§Ù„ÙƒØ£Ø³ ÙˆØ§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø§Ø±ÙŠØ©
const winSound = new Audio('./fireworks.mp3');
winSound.volume = 0.7;

// ØµÙˆØª Ø§Ù„Ù…ÙŠØ¯Ø§Ù„ÙŠØ© Ø§Ù„ÙØ¶ÙŠØ©
const silverMedalSound = new Audio('./silver.mp3');
silverMedalSound.volume = 0.6;

// ØµÙˆØª Ø§Ù„Ù…ÙŠØ¯Ø§Ù„ÙŠØ© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©
const goldMedalSound = new Audio('./gold.mp3');
const victoryJingleSound = new Audio('./cup.mp3');
goldMedalSound.volume = 0.6;
victoryJingleSound.volume = 0.6;

// â–¼â–¼â–¼ Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ù‡Ù…Ø© â–¼â–¼â–¼
let soundsUnlocked = false;
function unlockSounds() {
    if (soundsUnlocked) return;
    
    // Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ´ØºÙŠÙ„Ù‡Ø§ ÙˆØ¥ÙŠÙ‚Ø§ÙÙ‡Ø§
    // Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙƒØ§ÙÙ Ù„Ù…Ø¹Ø¸Ù… Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© "Ù„ÙØªØ­ Ø§Ù„Ù‚ÙÙ„"
    winSound.load();
    silverMedalSound.load();
    goldMedalSound.load();
    clickSound.load();

    soundsUnlocked = true;
    console.log("Audio context unlocked by user interaction.");
}

// â–²â–²â–² Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© â–²â–²â–²



    
    clickSound.volume = 0.8; winSound.volume = 0.7; silverMedalSound.volume = 0.6; goldMedalSound.volume = 0.6;

    const ALL_EMOJIS = ['ğŸ¤ ','ğŸ˜','ğŸ¥·','ğŸ¤¡','ğŸ¦¸','ğŸ¦¹','ğŸ‘½','ğŸ¤–','ğŸ‘‘','ğŸ¦','ğŸ¯','ğŸº','ğŸ²','ğŸ¦Š','ğŸ¸','ğŸµ','ğŸ¦‰','ğŸ¨','ğŸ‘¨â€ğŸš€','ğŸ‘©â€ğŸš€','ğŸ‘¨â€ğŸ¨','ğŸ‘©â€ğŸ¨','ğŸ‘¨â€ğŸ’»','ğŸ‘©â€ğŸ’»','ğŸ‘¨â€ğŸ”¬','ğŸ‘©â€ğŸ”¬'];
    const CARD_COLORS = ["#8e44ad", "#e67e22", "#c0392b", "#2980b9", "#27ae60", "#f39c12", "#16a085"];

    const makeId = () => Math.random().toString(36).slice(2, 8);
    const todayTag = () => new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short'}).replace(/ /g,'').toUpperCase();

    const openModal = (m)=> m.style.display = "flex";
    const closeModal = (m)=> m.style.display = "none";

    function setRandomGradientBackground() {
      const gradients = [
        "linear-gradient(135deg, #0f2027, #203a43, #2c5364)", "linear-gradient(135deg, #13192e, #232d4b, #3e4a6d)",
        "linear-gradient(135deg, #23074d, #cc5333)", "linear-gradient(135deg, #1f1c2c, #928dab)",
        "linear-gradient(135deg, #16222a, #3a6073)", "linear-gradient(135deg, #373b44, #4286f4)",
        "linear-gradient(135deg, #000000, #434343)", "radial-gradient(circle, #2c3e50, #000000)"
      ];
      document.body.style.background = gradients[Math.floor(Math.random() * gradients.length)];
    }

    function hexToRgba(hex, alpha = 1) {
        const [r, g, b] = hex.match(/\w\w/g).map(x => parseInt(x, 16));
        return `rgba(${r},${g},${b},${alpha})`;
    }

    function getMedals(score) {
        const gold = Math.floor((score || 0) / 5);
        const silver = (score || 0) % 5;
        return "ğŸ¥‡".repeat(gold) + "ğŸ¥ˆ".repeat(silver);
    }

    function renderHeader() {
        const roomStatusText = isAdmin ? 'Ù…Ø´Ø±Ù' : 'Ù…Ø´Ø§Ù‡Ø¯';
        const bannerHtml = `
            <div class="header" id="roomBanner">
              <img id="bannerImage" src="./banner.jpg" alt="UNO Live Banner" class="banner-img">
              <div class="title">
                <span>ğŸ®</span>
                <span class="badge" id="roomStatus">${roomStatusText}</span>
              </div>
            </div>`;
        headerContainer.innerHTML = bannerHtml;
        document.getElementById("roomBanner").onclick = () => {
            const roomModal = document.getElementById("roomModal");
            const roomManagementView = document.getElementById('roomManagementView');
            const joinView = document.getElementById('joinView');
            const roomInfoBlock = document.getElementById('roomInfoBlock');
            roomManagementView.style.display = 'block';
            joinView.style.display = 'none';
            const hasRoom = !!roomId;
            roomInfoBlock.style.display = hasRoom ? 'block' : 'none';
            document.getElementById('openLog').style.display = hasRoom ? 'block' : 'none';
            document.getElementById('copyLinkBtn').style.display = hasRoom ? 'block' : 'none';
            openModal(roomModal);
        };
    }

    function playerCard(p, index){
      const cardColor = p.color || CARD_COLORS[index % CARD_COLORS.length];
      return `<div class="card" data-player-id="${p.id}" style="background-color: ${hexToRgba(cardColor, 0.8)};"><div class="card-body"><div class="score-area"><div class="arrow-group"><div class="arrow" data-act="left:+1">â–²</div><div class="arrow" data-act="left:-1">â–¼</div></div><div class="score-card">${p.left||0}</div></div><div class="center-col"><div class="emoji">${p.character||'ğŸ®'}</div><div class="name">${p.name||'Ù„Ø§Ø¹Ø¨'}</div></div><div class="score-area"><div class="score-card">${p.right||0}</div><div class="arrow-group"><div class="arrow" data-act="right:+1">â–²</div><div class="arrow" data-act="right:-1">â–¼</div></div></div></div><div class="badges"><span>${getMedals(p.left)}</span><span>${"ğŸ†".repeat(p.right||0)}</span></div></div>`;
    }

    function renderPlayers(list){
      renderHeader();
      playersEl.innerHTML = list.map((p, i) => playerCard(p, i)).join("");
    }

function triggerFireworks(winData) {
    const flashElement = document.getElementById('screen-flash');
    const canvas = document.getElementById('confetti-canvas');

    // --- (1) Ø¯Ø§Ù„Ø© Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ù…Ù†ÙØµÙ„Ø© (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…) ---
    function runFlashEffect() {
        const flashCount = 3; 
        const flashInterval = 120;
        for (let i = 0; i < flashCount; i++) {
            setTimeout(() => {
                flashElement.classList.add('active');
                setTimeout(() => { flashElement.classList.remove('active'); }, 60);
            }, i * flashInterval);
        }
    }

    // --- (2) ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª ---

    // Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø§Ø±ÙŠØ© ÙŠØ¨Ø¯Ø¢Ù† ÙÙˆØ±Ù‹Ø§
    runFlashEffect();
    
    canvas.classList.add('active');
    const winnerColor = winData.color || '#FFFFFF';
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠÙ† Ù…Ø¹Ù‹Ø§
    winSound.play().catch(e => {});
    victoryJingleSound.play().catch(e => {});

    const fire = confetti.create(canvas, { resize: true, useWorker: true });
    const duration = 5000;
    const end = Date.now() + duration;

    // --- (3) Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø«Ø§Ù†ÙŠ ---
    // Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ 3000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (3 Ø«ÙˆØ§Ù†Ù)
    setTimeout(runFlashEffect, 3000);

    // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø§Ø±ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    setTimeout(() => {
        canvas.classList.remove('active');
    }, duration);

    // Ø­Ù„Ù‚Ø© Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØµÙˆØ§Ø±ÙŠØ® (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
    (function frame() {
        if (Date.now() > end) return;
        const bannerRect = document.getElementById('roomBanner')?.getBoundingClientRect() || { bottom: 0 };
        fire({
            particleCount: 50, angle: 90, spread: 45, startVelocity: 55,
            origin: { x: Math.random(), y: 1 }, ticks: 150, gravity: 1,
            shapes: ['circle'], scalar: 0.6, colors: ['#FFFFFF', winnerColor]
        }).then(result => {
            if (!result || (bannerRect.bottom > 0 && (result.origin.y * window.innerHeight) < bannerRect.bottom)) return;
            fire({
                particleCount: 800, spread: 360, startVelocity: 40, origin: result.origin,
                gravity: 0.4, ticks: 500, decay: 0.94, shapes: ['circle'],
                scalar: 2.0, colors: [winnerColor, '#FFFFFF', '#FFD700']
            });
        });
        setTimeout(frame, 500 + Math.random() * 300);
    }());
}


    async function ensureAdminStatus(){
      if(!roomId || !adminToken) { isAdmin = false; return false; }
      const snap = await get(child(ref(db, `rooms/${roomId}`), 'adminKey'));
      isAdmin = !!(snap.exists() && adminToken === snap.val());
      document.getElementById('addPlayerFab').style.display = isAdmin ? 'flex' : 'none';
    }

    function handleScoreUpdate(id, side, delta) {
        if (!isAdmin) return;
        const playerRef = ref(db, `rooms/${roomId}/players/${id}`);
        get(playerRef).then(pSnap => {
            if(!pSnap.exists()) return;
            const p = pSnap.val();
            const oldValue = p[side] || 0;
            const newValue = Math.max(0, oldValue + delta);
            let updates = {};
            updates[`players/${id}/${side}`] = newValue;
            const date = todayTag();
            updates[`scoreLog/${date}_${p.name}`] = { date, name: p.name, wins: side === 'right' ? newValue : p.right || 0, medals: side === 'left' ? newValue : p.left || 0 };
            if (delta > 0) {
                if (side === 'left') {
                    const oldGoldCount = Math.floor(oldValue / 5);
                    const newGoldCount = Math.floor(newValue / 5);
                    if (newGoldCount > oldGoldCount) { goldMedalSound.play().catch(e => {}); }
                    else { silverMedalSound.play().catch(e => {}); }
                } else {
                    winSound.play().catch(e => {});
                    updates['lastWin'] = { timestamp: Date.now(), color: p.color || '#FFFFFF' };
                }
            }
            update(ref(db, `rooms/${roomId}`), updates);
        });
    }



// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© addPlayers Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
async function addPlayers() {
    // (1) ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const modal = document.getElementById('addPlayerModal');
    const input = document.getElementById('playerNamesInput');
    const addButton = document.getElementById('doAddPlayers');
    const cancelButton = document.getElementById('closeAddPlayerModal');

    // (2) Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    input.value = ''; // Ù†ÙØ±Øº Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†Ø¯ ÙƒÙ„ Ù…Ø±Ø© Ù†ÙØªØ­ ÙÙŠÙ‡Ø§ Ø§Ù„Ù†Ø§ÙØ°Ø©
    openModal(modal);

    // (3) ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    cancelButton.onclick = () => {
        closeModal(modal);
    };

    // (4) ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    addButton.onclick = async () => {
        if (!roomId || !isAdmin) {
            alert("ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø´Ø±ÙØ§Ù‹ ÙÙŠ ØºØ±ÙØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨.");
            return;
        }

        const namesInput = input.value; // Ù†Ø£Ø®Ø° Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        if (!namesInput) {
            closeModal(modal); // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºÙ‹Ø§ØŒ Ø£ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙ‚Ø·
            return;
        }

        // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø­Ø±ÙŠ ÙŠÙØµÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª Ù…ÙØµÙˆÙ„Ø© Ø¨Ù…Ø³Ø§ÙØ© Ø£Ùˆ Ø¨Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
        const names = namesInput.trim().split(/[\s\n]+/).filter(name => name.length > 0);
        
        if (names.length === 0) {
            closeModal(modal);
            return;
        }

        // --- Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ (Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¥Ù„Ù‰ Firebase) ---
        const playersSnap = await get(ref(db, `rooms/${roomId}/players`));
        const players = playersSnap.exists() ? playersSnap.val() : {};
        let usedEmojis = Object.values(players).map(p => p.character);
        let usedColors = Object.values(players).map(p => p.color);

        for (const name of names) {
            let availableEmojis = ALL_EMOJIS.filter(e => !usedEmojis.includes(e));
            if (availableEmojis.length === 0) availableEmojis = ALL_EMOJIS;
            const char = availableEmojis[Math.floor(Math.random() * availableEmojis.length)];
            usedEmojis.push(char);

            let availableColors = CARD_COLORS.filter(c => !usedColors.includes(c));
            if (availableColors.length === 0) availableColors = CARD_COLORS;
            const color = availableColors[0];
            usedColors.push(color);

            await set(child(ref(db, `rooms/${roomId}/players`), makeId()), { name, left: 0, right: 0, character: char, color });
        }
        // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ Ù„Ù… ÙŠØªØºÙŠØ± ---

        // (5) ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©ØŒ Ø£ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        closeModal(modal);
    };
}




    function initializeStaticEventListeners() {
        document.getElementById('addPlayerFab').addEventListener('click', () => { clickSound.play().catch(e => {}); addPlayers(); });
        document.getElementById('devInfoBtn').addEventListener('click', () => { clickSound.play().catch(e => {}); openModal(document.getElementById('devInfoModal')); });
        document.getElementById('refreshBtn').addEventListener('click', () => { clickSound.play().catch(e => {}); location.reload(); });
        document.getElementById("closeRoomModal").addEventListener('click', () => { clickSound.play().catch(e => {}); closeModal(document.getElementById('roomModal')); });
        document.getElementById("openLog").addEventListener('click', () => {
            clickSound.play().catch(e => {});
            closeModal(document.getElementById('roomModal'));
            const tbody = document.getElementById("logTbody");
            onValue(ref(db, `rooms/${roomId}/scoreLog`), (snap) => {
                if(!snap.exists()){ tbody.innerHTML = `<tr><td colspan="4" class="subtle">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</td></tr>`; return; }
                const list = Object.values(snap.val());
                list.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
                tbody.innerHTML = list.map(e=>`<tr><td>${e.date}</td><td>${e.name}</td><td>${e.wins||0}</td><td>${e.medals||0}</td></tr>`).join("");
            }, { onlyOnce: true });
            openModal(document.getElementById('logModal'));
        });
        document.getElementById("closeLog").addEventListener('click', () => { clickSound.play().catch(e => {}); closeModal(document.getElementById('logModal')); });
        document.getElementById("closeDeleteModal").addEventListener('click', () => { clickSound.play().catch(e => {}); closeModal(document.getElementById('deleteModal')); });
        document.getElementById("closeDevInfoModal").addEventListener('click', () => { clickSound.play().catch(e => {}); closeModal(document.getElementById('devInfoModal')); });
        document.getElementById('showJoinView').addEventListener('click', () => { clickSound.play().catch(e => {}); document.getElementById('roomManagementView').style.display = 'none'; document.getElementById('joinView').style.display = 'block'; });
        document.getElementById('backToManagement').addEventListener('click', () => { clickSound.play().catch(e => {}); document.getElementById('joinView').style.display = 'none'; document.getElementById('roomManagementView').style.display = 'block'; });
        document.getElementById("doCreate").addEventListener('click', async () => {
          clickSound.play().catch(e => {});
          const newRoomId = makeId(), newAdminKey = makeId();
          await set(ref(db, `rooms/${newRoomId}`), { createdAt: Date.now(), adminKey: newAdminKey });
          const adminTokens = JSON.parse(localStorage.getItem("uno-admin-tokens") || '{}');
          adminTokens[newRoomId] = newAdminKey;
          localStorage.setItem("uno-admin-tokens", JSON.stringify(adminTokens));
          history.replaceState({}, "", `${location.origin}${location.pathname}?room=${newRoomId}&admin=${newAdminKey}`);
          location.reload();
        });
        document.getElementById("doJoin").addEventListener('click', async () => {
          clickSound.play().catch(e => {});
          const joinRoomId = document.getElementById("joinId").value.trim();
          if(!joinRoomId){ alert("Ø§ÙƒØªØ¨ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©"); return; }
          const exists = (await get(child(ref(db, 'rooms'), joinRoomId))).exists();
          if(!exists){ alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"); return; }
          const adminTokens = JSON.parse(localStorage.getItem("uno-admin-tokens") || '{}');
          const newAdminToken = adminTokens[joinRoomId] || '';
          const url = new URL(location.href);
          url.searchParams.set('room', joinRoomId);
          if (newAdminToken) { url.searchParams.set('admin', newAdminToken); }
          else { url.searchParams.delete('admin'); }
          history.replaceState({}, "", url.toString());
          location.reload();
        });
        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            clickSound.play().catch(e => {});
            const viewUrl = new URL(location.href);
            viewUrl.searchParams.delete('admin');
            navigator.clipboard.writeText(viewUrl.toString()).then(() => alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©!'), () => alert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·.'));
        });
        document.getElementById('deletePlayerBtn').addEventListener('click', () => {
            clickSound.play().catch(e => {});
            if (currentTargetPlayerId) { remove(ref(db, `rooms/${roomId}/players/${currentTargetPlayerId}`)); }
            closeModal(document.getElementById('deleteModal'));
        });
        document.getElementById('deleteAllBtn').addEventListener('click', () => {
            clickSound.play().catch(e => {});
            if (confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                remove(ref(db, `rooms/${roomId}/players`));
            }
            closeModal(document.getElementById('deleteModal'));
        });
    }

        function initializeDynamicEventListeners() {
        let longPressTimer, isLongPress = false, touchEventDetected = false;
        const handlePress = (target) => {
            if (!isAdmin) return;
            const emojiEl = target.closest('.emoji');
            if (emojiEl) {
                isLongPress = false;
                const card = emojiEl.closest('.card');
                currentTargetPlayerId = card.dataset.playerId;
                longPressTimer = setTimeout(() => { isLongPress = true; openModal(document.getElementById('deleteModal')); }, 800);
            }
        };
        const handleRelease = (target) => {
            clearTimeout(longPressTimer);
            const arrow = target.closest('.arrow');
            if (arrow && !isLongPress) {
                const card = arrow.closest('.card');
                const playerId = card.dataset.playerId;
                const { act } = arrow.dataset;
                const [side, deltaStr] = act.split(":");
                handleScoreUpdate(playerId, side, parseInt(deltaStr, 10));
            }
        };
        playersEl.addEventListener('touchstart', (e) => { touchEventDetected = true; handlePress(e.target); }, { passive: true });
        playersEl.addEventListener('touchend', (e) => { if (!touchEventDetected) return; handleRelease(e.target); });
        playersEl.addEventListener('mousedown', (e) => { if (touchEventDetected || e.button !== 0) return; handlePress(e.target); });
        playersEl.addEventListener('mouseup', (e) => { if (touchEventDetected || e.button !== 0) return; handleRelease(e.target); });
        const cancelPress = () => clearTimeout(longPressTimer);
        playersEl.addEventListener('touchcancel', cancelPress);
        playersEl.addEventListener('mouseleave', cancelPress);
    }

    (async function boot(){
      setRandomGradientBackground();
      initializeStaticEventListeners();
      await ensureAdminStatus();

      if(!roomId){
        renderHeader();
        document.getElementById('addPlayerFab').style.display = 'none';
        openModal(document.getElementById('roomModal'));
      } else {
        modalRoomId.textContent = roomId;
        localStorage.setItem("uno-room-id", roomId);

        onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
            const playersData = snap.exists() ? snap.val() : {};
            const players = Object.entries(playersData).map(([id, v]) => ({ id, ...v }));
            players.sort((a, b) => (b.right || 0) - (a.right || 0) || (b.left || 0) - (a.left || 0));
            renderPlayers(players);
        });

        onValue(ref(db, `rooms/${roomId}/lastWin`), (snap) => {
            if (snap.exists()) {
                const winData = snap.val();
                triggerFireworks(winData); 
                if (isAdmin) {
                    remove(ref(db, `rooms/${roomId}/lastWin`));
                }
            }
        });
      }
      
      initializeDynamicEventListeners();
    })();
  </script>
</body>
</html>
