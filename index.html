<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNO Live – غرف + مشرف</title>
  <style>
    :root {
      --bg:#0f1220; --card:#171a2b; --text:#e8ecff; --muted:#9aa3c7; --accent:#7aa2ff;
      --red:#ff4d4f; --yellow:#ffcd38; --green:#2ed573; --blue:#1e90ff; --purple:#a55eea; --orange:#ffa502;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Tahoma, Arial; background:linear-gradient(180deg,#0f1220,#0a0c18); color:var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .header {
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(90deg, #1a1f35, #111527);
      border:1px solid #2a3257; padding:12px 14px; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .title { font-weight: 800; letter-spacing:.5px; font-size: 20px; display:flex; align-items:center; gap:10px; cursor:pointer; }
    .title .badge { font-size: 12px; color: var(--muted); border:1px dashed #303a66; padding: 2px 8px; border-radius: 999px; }
    .room { font-size: 13px; color: var(--muted); }
    .btn {
      appearance:none; border:0; background:#1f2740; color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer;
      outline: none; border:1px solid #2b355c; font-weight:600; transition:.15s transform ease,.15s background ease;
    }
    .btn:hover { background:#243056; transform: translateY(-1px); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px; margin-top:14px; }
    .card {
      background:var(--card); border:1px solid #2a3257; border-radius:18px; padding:12px; box-shadow: 0 6px 18px rgba(0,0,0,.2);
    }
    .row { display:grid; grid-template-columns: 38px 1fr 38px; align-items:center; gap:10px; }
    .col { display:flex; flex-direction:column; align-items:center; gap:6px; }
    .arrow { width:34px; height:36px; display:grid; place-items:center; border-radius:10px; background:#1f2740; border:1px solid #2b355c; user-select:none; }
    .arrow:active { transform: translateY(1px); }
    .score { font-size: 40px; font-weight: 900; text-align:center; }
    .center { text-align:center; }
    .name { margin-top:4px; font-weight:800; font-size:18px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .badges { display:flex; justify-content:space-between; gap:8px; margin-top:10px; font-size:20px; }
    .subtle { color: var(--muted); font-size: 13px; }
    .footer-actions { display:flex; gap:10px; margin-top:16px; flex-wrap: wrap; }
    .muted { opacity:.75 }
    .pill { display:inline-flex; align-items:center; gap:6px; background:#1f2740; border:1px solid #2b355c; padding:6px 10px; border-radius:999px; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:40; }
    .modal{ width:min(92vw,560px); background:#151935; border:1px solid #2a3257; border-radius:18px; padding:18px; }
    .modal h3{ margin:0 0 8px; }
    .input, input[type=text]{ width:100%; background:#0f142e; color:var(--text); border:1px solid #28325b; border-radius:12px; padding:10px 12px; outline:none; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .link { word-break: break-all; background:#0e1430; border:1px dashed #2a3257; padding:8px 10px; border-radius:10px; }
    table{ width:100%; border-collapse: collapse; }
    th,td{ border-bottom:1px solid #2a3257; padding:8px; text-align:center; }
    th{ color:var(--muted) }
    .hint{ font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title" id="openLog" title="اضغط لعرض السجل">
        <span style="font-size: 26px;">🎮</span>
        UNO Live
        <span class="badge">متزامن</span>
      </div>
      <div class="room">
        <span id="roomLabel">لم يتم اختيار غرفة</span>
      </div>
      <div class="footer-actions">
        <button class="btn" id="btnCreate">إنشاء غرفة</button>
        <button class="btn" id="btnJoin">دخول غرفة</button>
        <button class="btn" id="btnAdd" title="إضافة لاعب">+ إضافة لاعب</button>
      </div>
    </div>

    <div class="grid" id="players"></div>

    <div class="card" style="margin-top:14px">
      <div class="pill"><span>ℹ️</span><span class="subtle">المشرف فقط يمكنه التعديل – البقية يشاهدون</span></div>
      <div class="hint" style="margin-top:8px">شارك رابط المشاهد مع الجميع، واحتفظ برابط المشرف لك فقط.</div>
    </div>
  </div>

  <!-- نافذة إنشاء/دخول غرفة -->
  <div class="modal-backdrop" id="roomModal">
    <div class="modal">
      <h3>اختيار غرفة</h3>
      <div class="row2">
        <button class="btn" id="doCreate">إنشاء غرفة جديدة</button>
        <div style="display:flex; gap:6px; align-items:center;">
          <input type="text" id="joinId" class="input" placeholder="أدخل رمز الغرفة (Room ID)" />
          <button class="btn" id="doJoin">دخول</button>
        </div>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:flex-end;">
        <button class="btn" id="closeRoomModal">إغلاق</button>
      </div>
    </div>
  </div>

  <!-- نافذة السجل -->
  <div class="modal-backdrop" id="logModal">
    <div class="modal">
      <h3>سجل النتائج</h3>
      <table>
        <thead><tr><th>التاريخ</th><th>الاسم</th><th>الكؤوس</th><th>الميداليات</th></tr></thead>
        <tbody id="logTbody"><tr><td colspan="4" class="subtle">لا توجد سجلات بعد</td></tr></tbody>
      </table>
      <div style="margin-top:10px; display:flex; justify-content:flex-end;">
        <button class="btn" id="closeLog">إغلاق</button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Firebase (v10) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGuiMxffwcm_P8zY-I6hMUG1hUY1akpFA",
      authDomain: "uno-game-live.firebaseapp.com",
      databaseURL: "https://uno-game-live-default-rtdb.firebaseio.com",
      projectId: "uno-game-live",
      storageBucket: "uno-game-live.appspot.com",
      messagingSenderId: "973862287578",
      appId: "1:973862287578:web:0bac6d3788c78666e48de3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- State ---
    const qs = new URLSearchParams(location.search);
    let roomId = qs.get("room") || localStorage.getItem("uno-room") || "";
    let adminTokenParam = qs.get("admin") || "";
    let isAdmin = false;
    const playersEl = document.getElementById("players");
    const roomLabel = document.getElementById("roomLabel");

    // --- Helpers ---
    const CARTOON = ['🤠','😎','🥷','🤡','🦸‍♂️','🦹‍♀️','👽','🤖','👑','🦁','🐯','🐺','🐲','🦊','🐸','🐵','🦉','🐨','🎯','🎮','🏆','⭐','💎','🎭','🔥','❄️','🌟'];
    const UNO = ['uno-red','uno-yellow','uno-green','uno-blue','uno-purple','uno-orange'];
    const todayTag = () => new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short'}).replace(/ /g,'').toUpperCase();
    const makeId = () => Math.random().toString(36).slice(2,7) + Math.random().toString(36).slice(2,5);

    function playerCard(p){
      const gold = Math.floor((p.left||0)/5);
      const silver = (p.left||0) % 5;
      const medals = "🥇".repeat(gold) + "🥈".repeat(silver);
      const cups = "🏆".repeat(p.right||0);
      return `
        <div class="card">
          <div class="row">
            <div class="col">
              <div class="arrow" data-act="left:+1" data-id="${p.id}">▲</div>
              <div class="arrow" data-act="left:-1" data-id="${p.id}">▼</div>
            </div>
            <div class="center">
              <div class="score">${p.left||0}</div>
              <div style="font-size:48px">${p.character||'🎮'}</div>
              <div class="name">${p.name||'لاعب'}</div>
            </div>
            <div class="col">
              <div class="arrow" data-act="right:+1" data-id="${p.id}">▲</div>
              <div class="arrow" data-act="right:-1" data-id="${p.id}">▼</div>
            </div>
          </div>
          <div class="badges"><span>${medals||' '}</span><span>${cups||' '}</span></div>
          ${isAdmin ? `<div class="subtle" style="text-align:center;margin-top:6px">انقر الأسهم لتعديل النقاط</div>`:''}
        </div>
      `;
    }

    function renderPlayers(list){
      playersEl.innerHTML = list.map(playerCard).join("");
      playersEl.querySelectorAll(".arrow").forEach(btn => {
        btn.onclick = async (e) => {
          if(!isAdmin){ alert("هذه العملية للمشرف فقط."); return; }
          const id = btn.getAttribute("data-id");
          const [side, deltaStr] = btn.getAttribute("data-act").split(":");
          const delta = parseInt(deltaStr, 10);
          const pSnap = await get(child(ref(db), `rooms/${roomId}/players/${id}`));
          if(!pSnap.exists()) return;
          const p = pSnap.val();
          const left = side==="left" ? Math.max(0,(p.left||0)+delta) : (p.left||0);
          const right = side==="right" ? Math.max(0,(p.right||0)+delta) : (p.right||0);
          await update(ref(db, `rooms/${roomId}/players/${id}`), { left, right });
          const date = todayTag();
          await update(ref(db, `rooms/${roomId}/scoreLog/${date}_${p.name}`),
            { date, name:p.name, wins:right, medals:left });
        };
      });
    }

    function listenRoom(){
      if(!roomId) return;
      roomLabel.textContent = `الغرفة: ${roomId}${isAdmin?' • (مشرف)':''}`;
      localStorage.setItem("uno-room", roomId);

      onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
        const players = snap.exists() ? Object.entries(snap.val()).map(([id,v])=>({id, ...v})) : [];
        players.sort((a,b)=> (b.right||0)-(a.right||0) || (b.left||0)-(a.left||0));
        renderPlayers(players);
      });

      onValue(ref(db, `rooms/${roomId}/scoreLog`), (snap) => {
        const tbody = document.getElementById("logTbody");
        if(!snap.exists()){ tbody.innerHTML = `<tr><td colspan="4" class="subtle">لا توجد سجلات بعد</td></tr>`; return; }
        const list = Object.values(snap.val());
        list.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
        tbody.innerHTML = list.map(e=>`<tr><td>${e.date}</td><td>${e.name}</td><td>${e.wins||0}</td><td>${e.medals||0}</td></tr>`).join("");
      });
    }

    async function ensureAdminStatus(){
      if(!roomId) return false;
      const snap = await get(ref(db, `rooms/${roomId}/adminKey`));
      const key = snap.exists() ? snap.val() : null;
      isAdmin = !!(key && adminTokenParam && adminTokenParam === key);
      return isAdmin;
    }

    document.getElementById("btnAdd").onclick = async () => {
      if(!roomId){ alert("اختر غرفة أولاً."); return; }
      if(!isAdmin){ alert("هذه العملية للمشرف فقط."); return; }
      const name = prompt("اسم اللاعب:");
      if(!name) return;
      const id = makeId();
      const char = CARTOON[Math.floor(Math.random()*CARTOON.length)];
      await set(ref(db, `rooms/${roomId}/players/${id}`), { name, left:0, right:0, character:char });
    };

    const roomModal = document.getElementById("roomModal");
    const logModal = document.getElementById("logModal");
    const openModal = (m)=> m.style.display = "flex";
    const closeModal = (m)=> m.style.display = "none";

    document.getElementById("btnCreate").onclick = ()=> openModal(roomModal);
    document.getElementById("btnJoin").onclick = ()=> openModal(roomModal);
    document.getElementById("closeRoomModal").onclick = ()=> closeModal(roomModal);

    document.getElementById("openLog").onclick = ()=> openModal(logModal);
    document.getElementById("closeLog").onclick = ()=> closeModal(logModal);

    document.getElementById("doCreate").onclick = async () => {
      const newRoom = makeId();
      const adminKey = makeId();
      await set(ref(db, `rooms/${newRoom}`), {
        createdAt: Date.now(), adminKey
      });
      roomId = newRoom;
      adminTokenParam = adminKey;
      await ensureAdminStatus();
      listenRoom();
      closeModal(roomModal);
      const adminUrl = `${location.origin}${location.pathname}?room=${roomId}&admin=${adminKey}`;
      const viewerUrl = `${location.origin}${location.pathname}?room=${roomId}`;
      alert(`تم إنشاء الغرفة:
Room ID: ${roomId}

رابط المشرف:
${adminUrl}

رابط المشاهد:
${viewerUrl}`);
      history.replaceState({}, "", adminUrl);
    };

    document.getElementById("doJoin").onclick = async () => {
      const id = document.getElementById("joinId").value.trim();
      if(!id){ alert("اكتب رمز الغرفة"); return; }
      const exists = (await get(ref(db, `rooms/${id}`))).exists();
      if(!exists){ alert("الغرفة غير موجودة"); return; }
      roomId = id;
      await ensureAdminStatus();
      listenRoom();
      closeModal(roomModal);
      const newUrl = isAdmin
        ? `${location.origin}${location.pathname}?room=${roomId}&admin=${adminTokenParam}`
        : `${location.origin}${location.pathname}?room=${roomId}`;
      history.replaceState({}, "", newUrl);
    };

    (async function boot(){
      if(!roomId){ openModal(roomModal); }
      else {
        await ensureAdminStatus();
        listenRoom();
      }
    })();
  </script>

  <script>
    const style = document.createElement("style");
    style.textContent = `
      .uno-red{ outline: 2px solid rgba(255,77,79,.35) }
      .uno-yellow{ outline: 2px solid rgba(255,205,56,.35) }
      .uno-green{ outline: 2px solid rgba(46,213,115,.35) }
      .uno-blue{ outline: 2px solid rgba(30,144,255,.35) }
      .uno-purple{ outline: 2px solid rgba(165,94,234,.35) }
      .uno-orange{ outline: 2px solid rgba(255,165,2,.35) }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
